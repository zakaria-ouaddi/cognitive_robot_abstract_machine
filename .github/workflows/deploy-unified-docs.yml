name: Deploy Unified Documentation to GitHub Pages

on:
  push:
    branches:
      - main
    paths:
      - 'krrood/doc/**'
      - 'pycram/doc/**'
      - 'semantic_digital_twin/doc/**'
      - 'docs_index.md'
      - '.github/workflows/deploy-unified-docs.yml'

# This workflow builds all documentation and deploys to GitHub Pages
jobs:
  # ============================================================================
  # Build krrood documentation
  # ============================================================================
  build-krrood-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: pip

    - name: Install krrood dependencies
      working-directory: ./krrood
      run: |
        pip install -U pip setuptools
        pip install -r requirements-dev.txt
        pip install .
        pip install -r doc/requirements.txt

    - name: Build krrood documentation
      working-directory: ./krrood
      run: |
        jupyter-book build doc

    - name: Upload krrood docs
      uses: actions/upload-artifact@v4
      with:
        name: krrood-docs
        path: krrood/doc/_build/html

  # ============================================================================
  # Build pycram documentation
  # ============================================================================
  build-pycram-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: pip

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y graphviz graphviz-dev

    - name: Install pycram dependencies
      working-directory: ./pycram
      run: |
        pip install -U pip setuptools
        pip install -r requirements.txt
        pip install -r doc/requirements.txt

    - name: Build pycram documentation
      working-directory: ./pycram/doc/source
      run: |
        jupyter-book build .

    - name: Upload pycram docs
      uses: actions/upload-artifact@v4
      with:
        name: pycram-docs
        path: pycram/doc/source/_build/html

  # ============================================================================
  # Build semantic_digital_twin documentation
  # ============================================================================
  build-semantic-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    container:
      image: "pycram/semantic_world:jazzy"
    defaults:
      run:
        shell: bash -ieo pipefail {0}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        path: "ros/src/semantic_digital_twin"
        repository: ${{ github.repository }}
        ref: ${{ github.ref }}
        submodules: 'false'

    - name: Update semantic_digital_twin source files
      run: |
        rm -rf /opt/ros/semantic_digital_twin/* 
        cd /opt/ros/semantic_digital_twin
        rm -rf .git .github .gitignore .gitmodules .readthedocs.yaml
        cp -r /__w/${{ github.event.repository.name }}/${{ github.event.repository.name }}/ros/src/semantic_digital_twin /opt/ros

    - name: Install dependencies
      run: |
        sudo apt-get update
        cd /opt/ros/semantic_digital_twin
        source /opt/ros/semantic_digital_twin-venv/bin/activate
        pip install -U pip && pip install -r requirements.txt && pip install . && pip install -r doc/requirements.txt

    - name: Strip exercise-tagged cells in self_assessment/exercises/
      run: |
        cd /opt/ros/semantic_digital_twin/doc/self_assessment/exercises
        source /opt/ros/semantic_digital_twin-venv/bin/activate
        find . -type f -name '*.md' -print0 | while IFS= read -r -d '' f; do
          ipynb="${f%.md}.ipynb"
          # md:myst -> ipynb
          jupytext --from md:myst --to ipynb "$f" -o "$ipynb"
          # drop cells tagged "exercise"
          jupyter nbconvert --config /opt/ros/semantic_digital_twin/scripts/configs/nb_remove_exercises.json \
            --to notebook --inplace \
            "$ipynb"
          # ipynb -> md:myst (overwrite original .md)
          jupytext --to md:myst "$ipynb" -o "$f"
          rm -f "$ipynb"
        done

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Build semantic_digital_twin documentation
      run: |
        cd /opt/ros/semantic_digital_twin
        source /opt/ros/overlay_ws/install/setup.bash
        source /opt/ros/semantic_digital_twin-venv/bin/activate
        jupyter-book build doc

    - name: Upload semantic_digital_twin docs
      uses: actions/upload-artifact@v4
      with:
        name: semantic-docs
        path: /opt/ros/semantic_digital_twin/doc/_build/html

  # ============================================================================
  # Combine and deploy all documentation
  # ============================================================================
  deploy-combined-docs:
    needs: [build-krrood-docs, build-pycram-docs, build-semantic-docs]
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Download krrood docs
      uses: actions/download-artifact@v4.1.3
      with:
        name: krrood-docs
        path: _combined_docs/krrood

    - name: Download pycram docs
      uses: actions/download-artifact@v4.1.3
      with:
        name: pycram-docs
        path: _combined_docs/pycram

    - name: Download semantic_digital_twin docs
      uses: actions/download-artifact@v4.1.3
      with:
        name: semantic-docs
        path: _combined_docs/semantic_digital_twin

    - name: Checkout repository for index file
      uses: actions/checkout@v4
      with:
        sparse-checkout: |
          docs_index.md
        sparse-checkout-cone-mode: false

    - name: Setup index page
      run: |
        # Create .nojekyll to disable Jekyll processing
        touch _combined_docs/.nojekyll
        
        # Copy the markdown index file
        cp docs_index.md _combined_docs/index.md

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: _combined_docs

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
